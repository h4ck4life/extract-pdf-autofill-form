<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Form Extractor</title>
    <!-- PDF.js -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>
  <body
    class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300"
  >
    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <header class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">PDF Form Extractor</h1>
        <div class="flex items-center space-x-2">
          
            href="https://github.com/h4ck4life/extract-pdf-autofill-form"
            target="_blank"
            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
            title="GitHub Repository"
          >
            <i class="fab fa-github text-xl"></i>
          </a>
          <button
            id="themeToggle"
            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          >
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:block"></i>
          </button>
        </div>
      </header>

      <main>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
          <div
            id="dropArea"
            class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center cursor-pointer transition-colors hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700"
          >
            <div>
              <i
                class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"
              ></i>
              <h3 class="text-xl font-semibold mb-2">Upload PDF Document</h3>
              <p class="text-gray-500 dark:text-gray-400">
                Drag & drop a PDF file here, or click to select
              </p>
            </div>
            <input
              type="file"
              id="fileInput"
              accept="application/pdf"
              class="hidden"
            />
          </div>

          <div
            id="fileInfo"
            class="mt-4 flex items-center gap-2 p-2 border rounded hidden"
          >
            <i class="fas fa-file-pdf text-gray-500"></i>
            <span id="fileName" class="truncate flex-1"></span>
            <button
              id="changeFileBtn"
              class="px-3 py-1 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
            >
              Change
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">PDF Viewer</h2>
            <div
              id="pdfViewer"
              class="border border-gray-200 dark:border-gray-700 rounded-lg p-2 max-h-[500px] overflow-auto"
            >
              <canvas id="pdfCanvas" class="mx-auto"></canvas>
            </div>
            <div
              id="pdfNavigation"
              class="flex items-center justify-between mt-4 hidden"
            >
              <button
                id="prevPageBtn"
                class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <i class="fas fa-chevron-left mr-1"></i> Previous
              </button>
              <span id="pageInfo" class="text-sm">Page 1 of 1</span>
              <button
                id="nextPageBtn"
                class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Next <i class="fas fa-chevron-right ml-1"></i>
              </button>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Text Extractor</h2>
            <div class="mb-4">
              <label for="languageSelect" class="block text-sm font-medium mb-1"
                >Language</label
              >
              <select
                id="languageSelect"
                class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="eng">English</option>
                <option value="spa">Spanish</option>
                <option value="fra">French</option>
                <option value="deu">German</option>
                <option value="chi_sim">Chinese (Simplified)</option>
                <option value="jpn">Japanese</option>
                <option value="kor">Korean</option>
                <option value="ara">Arabic</option>
                <option value="rus">Russian</option>
              </select>
            </div>

            <div id="extractionProgress" class="mb-4 hidden">
              <div
                class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-1"
              >
                <div
                  id="progressBar"
                  class="bg-blue-500 h-2 rounded-full"
                  style="width: 0%"
                ></div>
              </div>
              <p
                id="progressText"
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Processing: 0%
              </p>
            </div>

            <div class="mt-6 space-y-3">
              <button
                id="extractCurrentBtn"
                class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <i class="fas fa-text-height mr-2"></i> Extract Current Page
              </button>
              <button
                id="extractAllBtn"
                class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <i class="fas fa-copy mr-2"></i> Extract All Pages & Fill Form
              </button>
            </div>
          </div>
        </div>

        <div
          id="resultCard"
          class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Extracted Text</h2>
            <div class="flex space-x-2">
              <button
                id="copyBtn"
                class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
              >
                <i class="fas fa-copy mr-1"></i> Copy
              </button>
            </div>
          </div>
          <div
            id="extractedText"
            class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 max-h-[300px] overflow-auto whitespace-pre-wrap"
          ></div>
        </div>

        <div
          id="formCard"
          class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hidden"
        >
          <h2 class="text-xl font-semibold mb-2">Auto-Filled Form</h2>
          <p class="text-gray-500 dark:text-gray-400 mb-6">
            The form below has been automatically filled based on the extracted
            text analysis.
          </p>

          <form id="dataForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="name" class="block text-sm font-medium mb-1"
                  >Full Name</label
                >
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label for="email" class="block text-sm font-medium mb-1"
                  >Email Address</label
                >
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label for="phone" class="block text-sm font-medium mb-1"
                  >Phone Number</label
                >
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label for="dob" class="block text-sm font-medium mb-1"
                  >Date of Birth</label
                >
                <input
                  type="date"
                  id="dob"
                  name="dob"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label for="idNumber" class="block text-sm font-medium mb-1"
                  >ID/Passport Number</label
                >
                <input
                  type="text"
                  id="idNumber"
                  name="idNumber"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label for="nationality" class="block text-sm font-medium mb-1"
                  >Nationality</label
                >
                <input
                  type="text"
                  id="nationality"
                  name="nationality"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            <div class="mt-4">
              <label for="address" class="block text-sm font-medium mb-1"
                >Address</label
              >
              <textarea
                id="address"
                name="address"
                rows="3"
                class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              ></textarea>
            </div>

            <div class="flex justify-end mt-6 space-x-4">
              <button
                type="button"
                id="editFormBtn"
                class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
              >
                <i class="fas fa-edit mr-1"></i> Edit
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white rounded transition-colors"
              >
                <i class="fas fa-paper-plane mr-1"></i> Submit
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>

    <!-- API Key Dialog -->
    <div
      id="apiKeyDialog"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6">
        <h3 class="text-xl font-semibold mb-4">Enter OpenAI API Key</h3>

        <p class="text-gray-600 dark:text-gray-400 mb-6">
          To extract and analyze PDF content with AI, please enter your OpenAI
          API key. Your key is stored locally in your browser and never sent to
          our servers.
        </p>

        <div class="mb-6">
          <label for="apiKey" class="block text-sm font-medium mb-1"
            >OpenAI API Key</label
          >
          <div class="relative">
            <input
              type="password"
              id="apiKey"
              placeholder="sk-..."
              class="w-full px-3 py-2 pr-10 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"
            />
            <button
              id="toggleKeyVisibility"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            Don't have an API key?
            <a
              href="https://platform.openai.com/account/api-keys"
              target="_blank"
              class="text-blue-500 hover:underline"
              >Get one here</a
            >
          </p>
        </div>

        <div
          id="apiKeyError"
          class="bg-red-100 text-red-800 p-3 rounded mb-4 hidden"
        >
          Please enter a valid OpenAI API key starting with 'sk-'
        </div>

        <div class="flex items-center mb-4">
          <input
            type="checkbox"
            id="rememberKey"
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4"
          />
          <label
            for="rememberKey"
            class="ml-2 text-sm text-gray-700 dark:text-gray-300"
          >
            Remember my API key for future sessions
          </label>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            id="cancelApiKeyBtn"
            class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
          >
            Cancel
          </button>
          <button
            id="confirmApiKeyBtn"
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white rounded transition-colors"
          >
            Confirm & Continue
          </button>
        </div>
      </div>
    </div>

    <!-- AI Processing Dialog -->
    <div
      id="aiProcessingDialog"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 text-center"
      >
        <div class="mb-4">
          <div
            class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-solid border-blue-500 border-r-transparent"
          ></div>
        </div>
        <h3 class="text-lg font-semibold mb-2">AI Processing</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-4" id="aiProgressText">
          Analyzing document and extracting information...
        </p>

        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
          <div
            id="aiProgressBar"
            class="bg-blue-500 h-2 rounded-full transition-all duration-300"
            style="width: 0%"
          ></div>
        </div>

        <div
          id="aiStepsList"
          class="text-left text-sm text-gray-600 dark:text-gray-400 mb-4"
        >
          <div class="flex items-center py-1">
            <div class="w-5 h-5 mr-2 flex-shrink-0">
              <i class="fas fa-circle-notch animate-spin text-blue-500"></i>
            </div>
            <span>Preprocessing document...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg transform transition-opacity duration-300 opacity-0 pointer-events-none"
    ></div>

    <script>
      // Main Application
      document.addEventListener("DOMContentLoaded", () => {
        // State
        const state = {
          pdfFile: null,
          pdfDocument: null,
          currentPage: 1,
          totalPages: 0,
          extractedText: {},
          extracting: false,
          extractingAllPages: false,
          language: "eng",
          worker: null,
          apiKey: localStorage.getItem("openai_api_key") || "",
          isDarkMode:
            localStorage.getItem("isDarkMode") !== null
              ? localStorage.getItem("isDarkMode") === "true"
              : window.matchMedia("(prefers-color-scheme: dark)").matches,
        };

        // DOM Elements
        const elements = {
          // File Upload
          dropArea: document.getElementById("dropArea"),
          fileInput: document.getElementById("fileInput"),
          fileInfo: document.getElementById("fileInfo"),
          fileName: document.getElementById("fileName"),
          changeFileBtn: document.getElementById("changeFileBtn"),

          // PDF Viewer
          pdfViewer: document.getElementById("pdfViewer"),
          pdfCanvas: document.getElementById("pdfCanvas"),
          pdfNavigation: document.getElementById("pdfNavigation"),
          prevPageBtn: document.getElementById("prevPageBtn"),
          nextPageBtn: document.getElementById("nextPageBtn"),
          pageInfo: document.getElementById("pageInfo"),

          // Extraction
          languageSelect: document.getElementById("languageSelect"),
          extractionProgress: document.getElementById("extractionProgress"),
          progressBar: document.getElementById("progressBar"),
          progressText: document.getElementById("progressText"),
          extractCurrentBtn: document.getElementById("extractCurrentBtn"),
          extractAllBtn: document.getElementById("extractAllBtn"),

          // Results
          resultCard: document.getElementById("resultCard"),
          extractedText: document.getElementById("extractedText"),
          copyBtn: document.getElementById("copyBtn"),

          // API Key Dialog
          apiKeyDialog: document.getElementById("apiKeyDialog"),
          apiKey: document.getElementById("apiKey"),
          toggleKeyVisibility: document.getElementById("toggleKeyVisibility"),
          rememberKey: document.getElementById("rememberKey"),
          apiKeyError: document.getElementById("apiKeyError"),
          cancelApiKeyBtn: document.getElementById("cancelApiKeyBtn"),
          confirmApiKeyBtn: document.getElementById("confirmApiKeyBtn"),

          // AI Processing Dialog
          aiProcessingDialog: document.getElementById("aiProcessingDialog"),
          aiProgressBar: document.getElementById("aiProgressBar"),
          aiProgressText: document.getElementById("aiProgressText"),
          aiStepsList: document.getElementById("aiStepsList"),

          // Toast
          toast: document.getElementById("toast"),

          // Theme
          themeToggle: document.getElementById("themeToggle"),

          // Form
          formCard: document.getElementById("formCard"),
          dataForm: document.getElementById("dataForm"),
          editFormBtn: document.getElementById("editFormBtn"),
        };

        // Initialize theme based on user preference
        if (state.isDarkMode) {
          document.documentElement.classList.add("dark");
        }

        // Initialize API key input if stored
        if (state.apiKey) {
          elements.apiKey.value = state.apiKey;
          elements.rememberKey.checked = true;
        }

        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

        // Event Listeners
        // File Upload
        elements.dropArea.addEventListener("click", () =>
          elements.fileInput.click()
        );
        elements.dropArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          elements.dropArea.classList.add(
            "border-blue-500",
            "bg-blue-50",
            "dark:bg-gray-700"
          );
        });
        elements.dropArea.addEventListener("dragleave", () => {
          elements.dropArea.classList.remove(
            "border-blue-500",
            "bg-blue-50",
            "dark:bg-gray-700"
          );
        });
        elements.dropArea.addEventListener("drop", (e) => {
          e.preventDefault();
          elements.dropArea.classList.remove(
            "border-blue-500",
            "bg-blue-50",
            "dark:bg-gray-700"
          );
          handleFiles(e.dataTransfer.files);
        });
        elements.fileInput.addEventListener("change", (e) => {
          handleFiles(e.target.files);
        });
        elements.changeFileBtn.addEventListener("click", () => {
          resetState();
          elements.fileInput.click();
        });

        // PDF Navigation
        elements.prevPageBtn.addEventListener("click", () => changePage(-1));
        elements.nextPageBtn.addEventListener("click", () => changePage(1));

        // Extraction
        elements.extractCurrentBtn.addEventListener(
          "click",
          extractCurrentPage
        );
        elements.extractAllBtn.addEventListener("click", () => {
          // Show API key dialog before extraction
          elements.apiKeyDialog.classList.remove("hidden");
        });

        // Results
        elements.copyBtn.addEventListener("click", copyToClipboard);

        // API Key Dialog
        elements.toggleKeyVisibility.addEventListener("click", () => {
          const apiKeyInput = elements.apiKey;
          if (apiKeyInput.type === "password") {
            apiKeyInput.type = "text";
            elements.toggleKeyVisibility.innerHTML =
              '<i class="fas fa-eye-slash"></i>';
          } else {
            apiKeyInput.type = "password";
            elements.toggleKeyVisibility.innerHTML =
              '<i class="fas fa-eye"></i>';
          }
        });

        elements.cancelApiKeyBtn.addEventListener("click", () => {
          elements.apiKeyDialog.classList.add("hidden");
          elements.apiKeyError.classList.add("hidden");
        });

        elements.confirmApiKeyBtn.addEventListener("click", () => {
          const apiKey = elements.apiKey.value.trim();

          // Validate API key
          if (!apiKey || !apiKey.startsWith("sk-")) {
            elements.apiKeyError.classList.remove("hidden");
            return;
          }

          // Store API key if remember is checked
          if (elements.rememberKey.checked) {
            localStorage.setItem("openai_api_key", apiKey);
          } else {
            localStorage.removeItem("openai_api_key");
          }

          // Update state
          state.apiKey = apiKey;

          // Hide dialog and start extraction
          elements.apiKeyDialog.classList.add("hidden");
          elements.apiKeyError.classList.add("hidden");

          // Start processing
          extractAllPages();
        });

        // Theme Toggle
        elements.themeToggle.addEventListener("click", toggleTheme);

        // Form
        elements.dataForm.addEventListener("submit", (e) => {
          e.preventDefault();
          showToast("Form submitted successfully!", false);
        });
        elements.editFormBtn.addEventListener("click", () => {
          // Just for demo, enable editing
          const inputs = elements.formCard.querySelectorAll("input, textarea");
          inputs.forEach((input) => {
            input.readOnly = false;
          });
          showToast("You can now edit the form fields", false);
        });

        // Functions
        function handleFiles(files) {
          if (files.length === 0) return;

          const file = files[0];
          if (file.type !== "application/pdf") {
            showToast("Please upload a PDF file", true);
            return;
          }

          resetState();
          state.pdfFile = file;
          elements.fileName.textContent = file.name;
          elements.fileInfo.classList.remove("hidden");

          loadPdf(file);
        }

        function resetState() {
          state.pdfFile = null;
          state.pdfDocument = null;
          state.currentPage = 1;
          state.totalPages = 0;
          state.extractedText = {};
          state.extracting = false;
          state.extractingAllPages = false;

          elements.pdfCanvas
            .getContext("2d")
            .clearRect(
              0,
              0,
              elements.pdfCanvas.width,
              elements.pdfCanvas.height
            );
          elements.pdfNavigation.classList.add("hidden");
          elements.extractCurrentBtn.disabled = true;
          elements.extractAllBtn.disabled = true;
          elements.extractionProgress.classList.add("hidden");
          elements.resultCard.classList.add("hidden");
          elements.formCard.classList.add("hidden");
          elements.fileInfo.classList.add("hidden");
        }

        async function loadPdf(file) {
          try {
            const arrayBuffer = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });

            state.pdfDocument = await loadingTask.promise;
            state.totalPages = state.pdfDocument.numPages;
            state.currentPage = 1;

            elements.pageInfo.textContent = `Page ${state.currentPage} of ${state.totalPages}`;
            elements.pdfNavigation.classList.remove("hidden");
            elements.extractCurrentBtn.disabled = false;
            elements.extractAllBtn.disabled = false;

            renderPage(state.currentPage);
          } catch (error) {
            console.error("Error loading PDF:", error);
            showToast("Failed to load PDF. Please try again.", true);
          }
        }

        async function renderPage(pageNumber) {
          try {
            const page = await state.pdfDocument.getPage(pageNumber);

            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = elements.pdfCanvas;
            const context = canvas.getContext("2d");

            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
              canvasContext: context,
              viewport: viewport,
            };

            await page.render(renderContext).promise;

            state.currentPage = pageNumber;
            elements.pageInfo.textContent = `Page ${pageNumber} of ${state.totalPages}`;

            // Update navigation buttons
            elements.prevPageBtn.disabled = pageNumber <= 1;
            elements.nextPageBtn.disabled = pageNumber >= state.totalPages;
          } catch (error) {
            console.error("Error rendering page:", error);
            showToast("Failed to render page. Please try again.", true);
          }
        }

        function changePage(offset) {
          const newPage = state.currentPage + offset;
          if (newPage >= 1 && newPage <= state.totalPages) {
            renderPage(newPage);
          }
        }

        async function extractCurrentPage() {
          if (state.extracting) return;

          state.extracting = true;
          elements.extractCurrentBtn.disabled = true;
          elements.extractionProgress.classList.remove("hidden");
          elements.progressBar.style.width = "0%";
          elements.progressText.textContent = "Processing: 0%";

          try {
            const canvas = elements.pdfCanvas;
            const imageData = canvas.toDataURL("image/png");

            const language = elements.languageSelect.value;

            if (!state.worker) {
              state.worker = await Tesseract.createWorker({
                logger: (message) => {
                  if (message.status === "recognizing text") {
                    const progress = Math.round(message.progress * 100);
                    elements.progressBar.style.width = `${progress}%`;
                    elements.progressText.textContent = `Processing: ${progress}%`;
                  }
                },
              });
            }

            await state.worker.loadLanguage(language);
            await state.worker.initialize(language);

            const result = await state.worker.recognize(imageData);
            const text = result.data.text;

            // Store the text with page number as key
            state.extractedText[
              state.currentPage
            ] = `## Page ${state.currentPage} of ${state.totalPages}\n\n${text}`;

            // Display results
            updateResults();
          } catch (error) {
            console.error("Error extracting text:", error);
            showToast("Failed to extract text. Please try again.", true);
          } finally {
            state.extracting = false;
            elements.extractCurrentBtn.disabled = false;
            elements.extractionProgress.classList.add("hidden");
          }
        }

        async function extractAllPages() {
          if (state.extracting || state.extractingAllPages) return;

          // Show AI processing dialog
          elements.aiProcessingDialog.classList.remove("hidden");
          elements.aiProgressBar.style.width = "0%";

          // Initialize processing steps display
          elements.aiStepsList.innerHTML = `
          <div class="flex items-center py-1">
            <div class="w-5 h-5 mr-2 flex-shrink-0">
              <i class="fas fa-circle-notch animate-spin text-blue-500"></i>
            </div>
            <span>Initializing OCR engine...</span>
          </div>
        `;

          state.extractingAllPages = true;
          elements.extractCurrentBtn.disabled = true;
          elements.extractAllBtn.disabled = true;

          try {
            // Initialize OCR worker
            if (!state.worker) {
              state.worker = await Tesseract.createWorker();
            }

            const language = elements.languageSelect.value;
            await state.worker.loadLanguage(language);
            await state.worker.initialize(language);

            // Update progress
            elements.aiProgressBar.style.width = "10%";
            elements.aiStepsList.innerHTML = `
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>OCR engine initialized</span>
            </div>
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0">
                <i class="fas fa-circle-notch animate-spin text-blue-500"></i>
              </div>
              <span id="extractionStatusText">Extracting text from pages (0/${state.totalPages})...</span>
            </div>
          `;

            // Clear previous results
            state.extractedText = {};

            // Process each page
            for (let pageNum = 1; pageNum <= state.totalPages; pageNum++) {
              // Update progress
              const progressPercent =
                10 + Math.round(((pageNum - 1) / state.totalPages) * 60);
              elements.aiProgressBar.style.width = `${progressPercent}%`;

              // Update the extraction status text
              document.getElementById(
                "extractionStatusText"
              ).textContent = `Extracting text from pages (${pageNum}/${state.totalPages})...`;

              // Render the page
              await renderPage(pageNum);

              // Extract text from the page
              const canvas = elements.pdfCanvas;
              const imageData = canvas.toDataURL("image/png");

              const result = await state.worker.recognize(imageData);
              const text = result.data.text;

              // Store the text with page number as key
              state.extractedText[
                pageNum
              ] = `## Page ${pageNum} of ${state.totalPages}\n\n${text}`;
            }

            // Update results
            updateResults();

            // Update progress after extraction is complete
            elements.aiProgressBar.style.width = "70%";
            elements.aiStepsList.innerHTML = `
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>OCR engine initialized</span>
            </div>
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>Text extraction complete (${state.totalPages}/${state.totalPages})</span>
            </div>
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0">
                <i class="fas fa-circle-notch animate-spin text-blue-500"></i>
              </div>
              <span>Analyzing text with AI to fill form...</span>
            </div>
          `;

            // Get combined text for sending to OpenAI
            const combinedText = Object.values(state.extractedText).join(
              "\n\n"
            );

            // Call OpenAI API
            const data = await callOpenAI(combinedText);

            // Update progress
            elements.aiProgressBar.style.width = "90%";
            elements.aiStepsList.innerHTML += `
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>AI analysis complete</span>
            </div>
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0">
                <i class="fas fa-circle-notch animate-spin text-blue-500"></i>
              </div>
              <span>Filling form with extracted data...</span>
            </div>
          `;

            // Fill form with data from OpenAI
            await fillFormWithData(data);

            // Complete progress
            elements.aiProgressBar.style.width = "100%";
            elements.aiStepsList.innerHTML = `
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>OCR engine initialized</span>
            </div>
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>Text extraction complete (${state.totalPages}/${state.totalPages})</span>
            </div>
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>AI analysis complete</span>
            </div>
            <div class="flex items-center py-1">
              <div class="w-5 h-5 mr-2 flex-shrink-0 text-green-500">
                <i class="fas fa-check-circle"></i>
              </div>
              <span>Form filled successfully</span>
            </div>
          `;

            // Hide processing dialog after a short delay
            setTimeout(() => {
              elements.aiProcessingDialog.classList.add("hidden");
              showToast(
                "Document processed and form filled successfully!",
                false
              );
            }, 1000);
          } catch (error) {
            console.error("Error processing document:", error);
            elements.aiProcessingDialog.classList.add("hidden");
            showToast("Failed to process document. Please try again.", true);
          } finally {
            state.extractingAllPages = false;
            elements.extractCurrentBtn.disabled = false;
            elements.extractAllBtn.disabled = false;
          }
        }

        async function callOpenAI(text) {
          try {
            // Using OpenAI with structured output for better parsing
            const requestData = {
              model: "gpt-4.1-nano",
              messages: [
                {
                  role: "system",
                  content:
                    "You are a helpful assistant that extracts structured information from documents.",
                },
                {
                  role: "user",
                  content: `Extract the following information from this document text: ${text}`,
                },
              ],
              functions: [
                {
                  name: "extract_person_info",
                  description:
                    "Extract and structure personal information from document text",
                  parameters: {
                    type: "object",
                    properties: {
                      name: {
                        type: "string",
                        description: "The person's full name",
                      },
                      email: {
                        type: "string",
                        description: "Email address",
                      },
                      phone: {
                        type: "string",
                        description: "Phone number",
                      },
                      dob: {
                        type: "string",
                        description:
                          "Date of birth in YYYY-MM-DD format if available",
                      },
                      idNumber: {
                        type: "string",
                        description: "ID or passport number",
                      },
                      nationality: {
                        type: "string",
                        description: "Nationality or citizenship",
                      },
                      address: {
                        type: "string",
                        description: "Full address",
                      },
                    },
                    required: ["name"],
                  },
                },
              ],
              function_call: { name: "extract_person_info" },
              temperature: 0.1,
            };

            // Call OpenAI API
            const response = await fetch(
              "https://api.openai.com/v1/chat/completions",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${state.apiKey}`,
                },
                body: JSON.stringify(requestData),
              }
            );

            if (!response.ok) {
              throw new Error(`OpenAI API error: ${response.status}`);
            }

            const responseData = await response.json();

            // Parse function call arguments from response
            if (
              responseData.choices &&
              responseData.choices[0] &&
              responseData.choices[0].message &&
              responseData.choices[0].message.function_call
            ) {
              const functionArgs = JSON.parse(
                responseData.choices[0].message.function_call.arguments
              );
              return functionArgs;
            } else {
              throw new Error("Unexpected API response format");
            }
          } catch (error) {
            console.error("Error calling OpenAI API:", error);
            // Return mock data if API call fails
            return getMockFormData();
          }
        }

        function getMockFormData() {
          // Mock data to use if OpenAI API call fails
          return {
            name: "John Smith",
            email: "john.smith@example.com",
            phone: "+1 (555) 123-4567",
            dob: "1985-06-15",
            idNumber: "ID12345678",
            nationality: "United States",
            address:
              "123 Main Street, Apt 4B\nNew York, NY 10001\nUnited States",
          };
        }

        async function fillFormWithData(data) {
          // Fill form fields with extracted data
          document.getElementById("name").value = data.name || "";
          document.getElementById("email").value = data.email || "";
          document.getElementById("phone").value = data.phone || "";
          document.getElementById("dob").value = data.dob || "";
          document.getElementById("idNumber").value = data.idNumber || "";
          document.getElementById("nationality").value = data.nationality || "";
          document.getElementById("address").value = data.address || "";

          // Show form card
          elements.formCard.classList.remove("hidden");

          // Mark fields as read-only initially
          const inputs = elements.formCard.querySelectorAll("input, textarea");
          inputs.forEach((input) => {
            input.readOnly = true;
          });
        }

        function updateResults() {
          // Sort pages and combine text
          const sortedPages = Object.keys(state.extractedText)
            .map((key) => parseInt(key))
            .sort((a, b) => a - b);

          if (sortedPages.length === 0) {
            elements.resultCard.classList.add("hidden");
            return;
          }

          const combinedText = sortedPages
            .map((page) => state.extractedText[page])
            .join("\n\n---\n\n");

          elements.extractedText.textContent = combinedText;
          elements.resultCard.classList.remove("hidden");
        }

        function copyToClipboard() {
          const text = elements.extractedText.textContent;
          if (!text) return;

          navigator.clipboard
            .writeText(text)
            .then(() => showToast("Text copied to clipboard", false))
            .catch(() => showToast("Failed to copy text", true));
        }

        function toggleTheme() {
          state.isDarkMode = !state.isDarkMode;
          if (state.isDarkMode) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
          // Save the preference
          localStorage.setItem("isDarkMode", state.isDarkMode);
        }

        function showToast(message, isError = false) {
          const toast = elements.toast;
          toast.textContent = message;
          toast.className =
            "fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 opacity-0";

          if (isError) {
            toast.classList.add("bg-red-500", "text-white");
          } else {
            toast.classList.add("bg-green-500", "text-white");
          }

          // Show toast
          setTimeout(() => {
            toast.classList.add("opacity-100");
          }, 10);

          // Hide toast after 3 seconds
          setTimeout(() => {
            toast.classList.remove("opacity-100");
            setTimeout(() => {
              toast.classList.add("opacity-0");
            }, 300);
          }, 3000);
        }
      });
    </script>
  </body>
</html>
